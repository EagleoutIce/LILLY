\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{LILLYxCONTROLLERxBOX}[2019/07/13 Stellt die Box-Erweiterung fuer LILLY zur Verfuegung]

\RequirePackage{LILLYxPACKAGExCTRL} %% DemandPackage und LoadPackage
\RequirePackage{LILLYxCONTROLLERxCONTENT}
\RequirePackage{LILLYxBOOLEAN}
\RequirePackage{LILLYxCOLOR}
\RequirePackage{LILLYxCONTROLLERxLINK}
\RequirePackage{LILLYxLIST}
\RequirePackage{LILLYxFONTS}

%% \RequirePackage{pgfkeys}
\LILLYxDemandPackage{pgfkeys}{Damit wir angenehme kv-pairs haben}
                    {Leider ist die graph-Umgebung auf dieses Paket angewiesen}
                    {}{}

%% https://www.ctan.org/pkg/tocloft
\LILLYxDemandPackage{tocloft}{Für Listen und so}%% Package, Info
                    {Das ist wichtig!}%% Error-Text
                    {}%%Params
                    {}%% Diese sind nicht optional, damit jake die benötigten Bibliothken weitaus einfacher finden kann :D

%% https://ctan.org/pkg/tcolorbox
\LILLYxDemandPackage{tcolorbox}{Fuer all die schoenen boexlis:D} %% Package, Info
                    {Dieses Paket ist für LILLY überlebenswichtig, ohne es gibt es keine Boxen!}%% Error-Text
                    {skins,many}%%Params
                    {}

%% https://ctan.org/pkg/environ
\LILLYxDemandPackage{environ}{Uebernimmt das leere environment ohne grosse Probleme} %% Package, Info
                    {Leider ist auch dieses Paket verpflichtend :/}%% Error-Text
                    {}%%Params
                    {}

%% https://ctan.org/pkg/bookmark
\LILLYxDemandPackage{bookmark}{Fuer bookmarks eben} %% Package, Info
                    {Dieses Paket ist für LILLY überlebenswichtig, ohne es gibt es keine Boxen, glaube ich!}%% Error-Text
                    {}%%Params
                    {}

%% https://ctan.org/pkg/calc
\LILLYxDemandPackage{calc}{Zur Berechnung der richtigen Masse} %% Package, Info
                    {Es ist wichtig, dass die dimensionen übereinstimmen}%% Error-Text
                    {}%%Params
                    {}


%% https://ctan.org/pkg/relsize
\LILLYxDemandPackage{relsize}{Machen wir alles ein bisschen relativer} %% Package, Info
                    {wuhuu, dann niiiicht}%% Error-Text
                    {}%%Params
                    {}




%%%%%%%%% Load Configs if applicable:
\ifnum\LILLYxSemester>0
    \RequestConfig{\LILLYxPATHxDATA/Semester/\LILLYxSemester/Definitions/GENERAL.tex}
    \RequestConfig{\LILLYxPATHxDATA/Semester/\LILLYxSemester/Definitions/\LILLYxVorlesung.tex}
    \typeout{LOADING: \LILLYxPATHxDATA/Semester/\LILLYxSemester/Definitions/\LILLYxVorlesung.tex}
\fi


%%%DEFAULTS

%% Hält, auch in verschactelten Systemen die entsprechend zu forcierende Farbe für Links oder anschmiegsame Farbgebung
\LILLYcommand{\LILLYxColorxLINKSxCurrentColor}{\LILLYxColorxLINKSxMainColor}

\gdef\LILLYxBOXxCOLORxFRAME{black!50}

\ifcsname LILLYxBOXxHIGHLEVELxLOCK\endcsname\else
\ifcsname chapter\endcsname
\def\LILLYxBOXxHIGHLEVELxLOCK{chapter}
\else\ifcsname section\endcsname
\def\LILLYxBOXxHIGHLEVELxLOCK{section}
\else
\def\LILLYxBOXxHIGHLEVELxLOCK{TRUE}
\fi\fi\fi
\let\@@olock\LILLYxBOXxHIGHLEVELxLOCK
\xdef\LILLYxBOXxHIGHLEVELxLOCK{\@@olock}

\constructList[,]{RegisteredBoxes}
\def\lilly@list@RegisteredBoxes{Definition/definition,Beispiel/beispiel,Bemerkung/bemerkung,Satz/satz,Beweis/beweis,Lemma/lemma,Zusammenfassung/zusammenfassung,Aufgabe/aufgabe,Uebungsblatt/uebungsblatt}

\getRegisteredBoxes

\ifcsname LILLYxBOXxUebungsblattxEnable\endcsname\else%
    \def\LILLYxBOXxUebungsblattxEnable{TRUE}%
\fi
\ifcsname LILLYxBOXxUebungsblattxBox\endcsname\else%
    \def\LILLYxBOXxUebungsblattxBox{TRUE}%
\fi


%\providecommand{\LILLYxBOXxUebungsblattxEnable}{TRUE}       \providecommand{\LILLYxBOXxUebungsblattxBox}{TRUE}
\foreach \elem/\ignore in \lillyxlist {
    \foreach \l/\val in {Lock/\LILLYxBOXxHIGHLEVELxLOCK,Enable/\true,Box/\true} {
        \typeout{\elem\space by \l\space using \val: LILLYxBOXx\elem x\l\space => \val }
        \ifcsname LILLYxBOXx\elem x\l\endcsname\else
            %\edef\v{\val}
            \typeout{There was no Setting given => Generate default}
            \expandafter\expandafter\expandafter\xdef\csname LILLYxBOXx\elem x\l\endcsname{\val}%
            %\expandafter\gnewcommand\csname LILLYxBOXx\x x\l\endcsname{\v}
        \fi
        \expandafter\typeout{Expected: \val, got: \csname LILLYxBOXx\elem x\l\endcsname}
    }
}

\newif\ifcreatelist
\newif\ifuselist
\pgfkeys {
    /lillyxBOX/.is family, /lillyxBOX,
    name/.estore in = \lillyxBoxxName,
    title/.store in = \lillyxBoxxTitle,
    boxcol/.estore in = \lillyxBoxxColor,
    preCode/.store in = \lillyxBoxxPrecode,
    inCode/.store in = \lillyxBoxxIncode,
    outCode/.store in = \lillyxBoxxOutcode,
    postCode/.store in = \lillyxBoxxPostcode,
    usestyle/.estore in = \lillyxBoxxUsestyle,
    %hasemblem/.estore in = \lillyxBoxxHasemblem,
    emblem/.store in = \lillyxBoxxEmblem,
    createlist/.is if = createlist,
    customlist/.is if = uselist,
    lock/.store in = \lillyxBoxxLock,
    listname/.store in = \lillyxBoxxListname,
    listtext/.store in =\lillyxBoxxListtext,
    listmen/.estore in =\lillyxBoxxListmen,
    defaults/.style={%
        name=noname, title={\noexpand\lillyxBoxxName},%
        boxcol=black,%
        usestyle=LILLYxBOXxDefinition, %hasemblem=FALSE,%
        emblem={XXNOEMBLEM}, listname={\noexpand\lillyxBoxxName}, createlist=false,%
        listtext={Alle \noexpand\lillyxBoxxName}, preCode={}, inCode={},%
        outCode={}, postCode={},lock={TRUE}, customlist=false,
        listmen=NO%
    }
}

\DeclareDocumentCommand{\RegisterBox}{%
    O{} %% Boxkeys
    O{} %% Optional Box TikzKeys
    m   %% Boxname (will overwrite boxnamekey)
    m   %% Title (will overwrite boxtitlekey)
    m   %% GroupID
}{%
    % \pgfkeys{/lillyxBox/#3/.is family, /lillyxBox/#3,%
    %     name/.store in=\csname lillyxBoxx#3xName,
    %     title/.default=none,
    %     usestyle/.default=none,
    %     hasemblem/.default=none,
    %     emblem/.default=none,
    %     listname/.default=none,
    %     createlist/.is if = createlist,
    %     customlist/.is if = uselist,
    %     listtext/.default=none,
    %     preCode/.default=none,
    %     inCode/.default=none,
    %     outCode/.default=none,
    %     postCode/.default=none%
    % }
    %\IfValueTF{#5}{\edef\theboxid{#5}}{\edef\theboxid{#3}}
    \edef\theboxid{#5}%
    % \pgfkeys{/lillyxBox/#3, name=#3, title=#4}
    \pgfkeys{/lillyxBOX, defaults, #1, name=#3,title=#4}%
    %% We will now persist the values, please be patient, this is try 14 to fix ns eval failures:
    \expandafter\xdef\csname lillyxBOXx\theboxid xName\endcsname{\lillyxBoxxName}%
    \expandafter\xdef\csname lillyxBOXx\theboxid xTitle\endcsname{\lillyxBoxxTitle}%
    \expandafter\xdef\csname lillyxBOXx\theboxid xBoxCol\endcsname{\lillyxBoxxColor}%
    \expandafter\xdef\csname lillyxBOXx\theboxid xPreCode\endcsname{\lillyxBoxxPrecode}%
    \expandafter\xdef\csname lillyxBOXx\theboxid xInCode\endcsname{\lillyxBoxxIncode}%
    \expandafter\xdef\csname lillyxBOXx\theboxid xOutCode\endcsname{\lillyxBoxxOutcode}%
    \expandafter\xdef\csname lillyxBOXx\theboxid xPostCode\endcsname{\lillyxBoxxPostcode}%
    \expandafter\xdef\csname lillyxBOXx\theboxid xUseStyle\endcsname{\lillyxBoxxUsestyle}%
    %\expandafter\xdef\csname lillyxBOXx\theboxid xHasemblem\endcsname{\lillyxBoxxHasemblem}%
    \expandafter\xdef\csname lillyxBOXx\theboxid xEmblem\endcsname{\lillyxBoxxEmblem}%
    \expandafter\xdef\csname lillyxBOXx\theboxid xLock\endcsname{\lillyxBoxxLock}%
    \expandafter\xdef\csname lillyxBOXx\theboxid xListName\endcsname{\lillyxBoxxListname}%
    \expandafter\xdef\csname lillyxBOXx\theboxid xListText\endcsname{\lillyxBoxxListtext}%
    \expandafter\xdef\csname lillyxBOXx\theboxid xListMen\endcsname{\lillyxBoxxListmen}%
    \expandafter\xdef\csname lillyxBOXx\theboxid xCreateList\endcsname{\ifcreatelist TRUE\else FALSE\fi}%
    \expandafter\xdef\csname lillyxBOXx\theboxid xCustomList\endcsname{\ifuselist TRUE\else FALSE\fi}%
    %% Persistence END
    \ifcreatelist\global\newlistof{\@nameuse{lillyxBOXx\theboxid xListName}}{\@nameuse{lillyxBOXx\theboxid xListMen}}{\@nameuse{lillyxBOXx\theboxid xListText}}\fi%
    %\expandafter\global\expandafter\newif\if
    \global\DeclareDocumentEnvironment{\lillyxBoxxName}{O{} O{}}{\ignorespaces% %%O{\theboxid}}{%
        \edef\curboxid{#5}\@nameuse{lillyxBOXx\curboxid xPreCode}\begin{\@nameuse{lillyxBOXx\curboxid xUseStyle}}[##1][\@nameuse{lillyxBOXx\curboxid xTitle}{}][#2,##2]%
            \@nameuse{lillyxBOXx\curboxid xInCode}\renewcommand{\LILLYxColorxLINKSxCurrentColor}{\@nameuse{lillyxBOXx\curboxid xBoxCol}}%
            \ifthenelse{\equal{\@nameuse{lillyxBOXx\curboxid xCustomList}}{TRUE}}{\typeout{#5 Box-Type will register itself to: \@nameuse{lillyxBOXx\curboxid xListName}}%
                \ifthenelse{\equal{\@nameuse{lillyxBOXx\curboxid xEmblem}}{XXNOEMBLEM}}{\typeout{\space>\space It will register without an Emblem/Addon!}%
            \LILLYxBOXESxaddListElement[\@nameuse{lillyxBOXx\curboxid xListName}]{\@nameuse{lillyxBOXx\curboxid xListMen}}{\thetcbcounter}{##1}{\@nameuse{lillyxBOXx\curboxid xLock}}%
            }{\typeout{\space>\space It will register with an Emblem/Addon!}%
                \LILLYxBOXESxaddListElementxAD[\@nameuse{lillyxBOXx\curboxid xListName}]{\@nameuse{lillyxBOXx\curboxid xListMen}}{\thetcbcounter}{##1}{\@nameuse{lillyxBOXx\curboxid xEmblem}}{\@nameuse{lillyxBOXx\curboxid xLock}}%%
            }%
            }{}\elable{auto:\@nameuse{lillyxBOXx\curboxid xListMen}\thetcbcounter}~\\[-.5\baselineskip]\ignorespacesafterend\ignorespaces%
    }{\@nameuse{lillyxBOXx\curboxid xOutCode}\end{\@nameuse{lillyxBOXx\curboxid xUseStyle}}\@nameuse{lillyxBOXx\curboxid xPostCode}\renewcommand{\LILLYxColorxLINKSxCurrentColor}{\LILLYxColorxLINKSxMainColor}\ignorespacesafterend}%
}

\DeclareDocumentCommand{\TransformBox}{%
    O{}                 %% New Args
    O{\BooleanFalse}    %% If \BooleanTrue => Do not delete old
    m                   %% Old BoxID
    m                   %% Box Title
    o                   %% New Name (can be old Name)
    m                   %% BoxID
}{%
    \typeout{Transform Box: #1<>#2<>#3<>#4<>#5<>#6<>}%
    \expandafter\ifcsname  lillyxBOXx#3xName\endcsname
        \edef\oldboxname{\csname lillyxBOXx#3xName\endcsname}
        \typeout{Registered Name from BoxID: #3}
    \else%
        \edef\oldboxname{#3}
        \typeout{Registered Name from a new Box, as no Old exists: #3}
    \fi%
    \IfBooleanF{#2}{\expandafter\let\csname\oldboxname\endcsname\@undefined}%% delete old
    %
    \IfValueTF{#5}{\def\thecboxname{#5}}{\def\thecboxname{\oldboxname}}%% set names
    %\IfValueTF{#5}{% % Here we will reload the old Values of
    % Check if there is an existing Box, and if, take the Configuration from it by the persisted Values of the old ID.
    \expandafter\ifcsname lillyxBOXx#3xName\endcsname
        \ifthenelse{\expandafter\equal{\csname lillyxBOXx#3xListMen\endcsname}{TRUE}}{\gdef\clisttmp{true}}{\gdef\clisttmp{false}}
        %\typeout{Switch-Pregeneration for clisttmp: \clisttmp}
        \RegisterBox[% Here we will reload the old Values of the Box, we won't erase them we'll just erase the environment-link in case of a renaming. Therefore it cann be still used as Base for another Box-Creation. We will (just for completeness) assign all commands:
        name=\csname lillyxBOXx#3xName\endcsname,%
        title=\csname lillyxBOXx#3xTitle\endcsname,%
        boxcol=\csname lillyxBOXx#3xBoxCol\endcsname,%
        preCode=\csname lillyxBOXx#3xPreCode\endcsname,%
        inCode=\csname lillyxBOXx#3xInCode\endcsname,%
        outCode=\csname lillyxBOXx#3xOutCode\endcsname,%
        postCode=\csname lillyxBOXx#3xPostCode\endcsname,%
        usestyle=\csname lillyxBOXx#3xUseStyle\endcsname,%
        emblem=\csname lillyxBOXx#3xEmblem\endcsname,%
        lock=\csname lillyxBOXx#3xLock\endcsname,%
        listname=\csname lillyxBOXx#3xListName\endcsname,%
        listtext=\csname lillyxBOXx#3xListText\endcsname,%
        listmen=\csname lillyxBOXx#3xListMen\endcsname,%
        createlist=false,% if it has been true we don't need to recreate it
        customlist=\clisttmp, % sloppy :D
        #1]{\thecboxname}{#4}{#6}
    \else\RegisterBox[#1]{\thecboxname}{#4}{#6}\fi%
    %}{\RegisterBox[#1]{\thecboxname}{#3}}%
}

\DeclareDocumentCommand{\TransformBoxDefinition}{%
    s   %% star for clone
    O{} %% Changed Args
    m   %% new Name
    m   %% new Title
    o   %% new ID
}{%
    \TransformBox[usestyle=LILLYxBOXxDefinition,customlist=true,listname=DEFINITIONS,listmen=DEFS,boxcol=\LILLYxColorxDefinition,emblem={},postCode={\noexpand\grenewcommand{\noexpand\LILLYxSEENxDEFINITION}{TRUE}},lock=\LILLYxBOXxDefinitionxLock,#2][#1]{definition}{#4}[#3]{\IfValueTF{#5}{#5}{definition}}%
}

\DeclareDocumentCommand{\TransformBoxDefinitionS}{%
    s   %% star for clone
    O{} %% Changed Args
    m   %% new Name
    m   %% new Title
    o   %% new ID
}{%
    \TransformBox[usestyle=LILLYxBOXxDefinition*,customlist=true,listname=DEFINITIONS,listmen=DEFS,boxcol=\LILLYxColorxDefinition,emblem={\noexpand\small\noexpand\faThumbTack},postCode={\noexpand\grenewcommand{\noexpand\LILLYxSEENxDEFINITION}{TRUE}},lock=\LILLYxBOXxDefinitionxLock,#2][#1]{definition*}{#4}[#3]{\IfValueTF{#5}{#5}{definitionstarred}}%
}

\DeclareDocumentCommand{\TransformBoxBemerkung}{%
    s   %% star for clone
    O{} %% Changed Args
    m   %% new Name
    m   %% new Title
    o   %% new ID
}{%
    \TransformBox[usestyle=LILLYxBOXxBemerkung,customlist=true,listname=BEMERKUNGEN,listmen=BEMS,boxcol=\LILLYxColorxBemerkung,emblem={XXNOEMBLEM},%postCode={\noexpand\grenewcommand{\noexpand\LILLYxSEENxDEFINITION}{TRUE}},
    lock=\LILLYxBOXxBemerkungxLock,#2][#1]{bemerkung}{#4}[#3]{\IfValueTF{#5}{#5}{bemerkung}}%
}

\DeclareDocumentCommand{\TransformBoxBemerkungS}{%
    s   %% star for clone
    O{} %% Changed Args
    m   %% new Name
    m   %% new Title
    o   %% new ID
}{%
    \TransformBox[usestyle=LILLYxBOXxBemerkung,customlist=true,listname=BEMERKUNGEN,listmen=BEMS,boxcol=\LILLYxColorxBemerkung,emblem={XXNOEMBLEM},inCode={\noexpand\nskip},%postCode={\noexpand\grenewcommand{\noexpand\LILLYxSEENxDEFINITION}{TRUE}},
    lock=\LILLYxBOXxBemerkungxLock,#2][#1]{bemerkung*}{#4}[#3]{\IfValueTF{#5}{#5}{bemerkungstarred}}%
}

\DeclareDocumentCommand{\TransformBoxBeispiel}{%
    s   %% star for clone
    O{} %% Changed Args
    m   %% new Name
    m   %% new Title
    o   %% new ID
}{%
    \TransformBox[usestyle=LILLYxBOXxBeispiel,customlist=true,listname=BEISPIELE,listmen=BEIS,boxcol=\LILLYxColorxBeispiel,emblem={XXNOEMBLEM},%postCode={\noexpand\grenewcommand{\noexpand\LILLYxSEENxDEFINITION}{TRUE}},
    lock=\LILLYxBOXxBeispielxLock,#2][#1]{beispiel}{#4}[#3]{\IfValueTF{#5}{#5}{beispiel}}%
}

\DeclareDocumentCommand{\TransformBoxBeispielS}{%
    s   %% star for clone
    O{} %% Changed Args
    m   %% new Name
    m   %% new Title
    o   %% new ID
}{%
    \TransformBox[usestyle=LILLYxBOXxBeispiel,customlist=true,listname=BEISPIELE,listmen=BEIS,boxcol=\LILLYxColorxBeispiel,emblem={XXNOEMBLEM},inCode={\noexpand\nskip},%postCode={\noexpand\grenewcommand{\noexpand\LILLYxSEENxDEFINITION}{TRUE}},
    lock=\LILLYxBOXxBeispielxLock,#2][#1]{beispiel*}{#4}[#3]{\IfValueTF{#5}{#5}{beispielstarred}}%
}

\DeclareDocumentCommand{\TransformBoxSatz}{%
    s   %% star for clone
    O{} %% Changed Args
    m   %% new Name
    m   %% new Title
    o   %% new ID
}{%
    \TransformBox[usestyle=LILLYxBOXxSatz,customlist=true,listname=SATZ,listmen=SATZE,boxcol=\LILLYxColorxSatz,emblem={XXNOEMBLEM},postCode={\noexpand\grenewcommand{\noexpand\LILLYxSEENxSATZ}{TRUE}},
    lock=\LILLYxBOXxSatzxLock,#2][#1]{satz}{#4}[#3]{\IfValueTF{#5}{#5}{satz}}%
}

%% No Starred Satz


\DeclareDocumentCommand{\TransformBoxBeweis}{%
    s   %% star for clone
    O{} %% Changed Args
    m   %% new Name
    m   %% new Title
    o   %% new ID
}{%
    \TransformBox[usestyle=LILLYxBOXxBeweis,customlist=true,listname=BEWEISE,listmen=BEWS,boxcol=\LILLYxColorxBeweis,emblem={XXNOEMBLEM},%postCode={\noexpand\grenewcommand{\noexpand\LILLYxSEENxDEFINITION}{TRUE}},
    lock=\LILLYxBOXxBeweisxLock,#2][#1]{beweis}{#4}[#3]{\IfValueTF{#5}{#5}{beweis}}%
}

\DeclareDocumentCommand{\TransformBoxBeweisS}{%
    s   %% star for clone
    O{} %% Changed Args
    m   %% new Name
    m   %% new Title
    o   %% new ID
}{%
    \TransformBox[usestyle=LILLYxBOXxBeweis,customlist=true,listname=BEWEISE,listmen=BEWS,boxcol=\LILLYxColorxBeweis,emblem={XXNOEMBLEM},inCode={\noexpand\nskip},%postCode={\noexpand\grenewcommand{\noexpand\LILLYxSEENxDEFINITION}{TRUE}},
    lock=\LILLYxBOXxBeweisxLock,#2][#1]{beweis*}{#4}[#3]{\IfValueTF{#5}{#5}{beweisstarred}}%
}

\DeclareDocumentCommand{\TransformBoxLemma}{%
    s   %% star for clone
    O{} %% Changed Args
    m   %% new Name
    m   %% new Title
    o   %% new ID
}{%
    \TransformBox[usestyle=LILLYxBOXxLemma,customlist=true,listname=LEMMAS,listmen=LEMME,boxcol=\LILLYxColorxLemma,emblem={},postCode={\noexpand\grenewcommand{\noexpand\LILLYxSEENxLEMMA}{TRUE}},
    lock=\LILLYxBOXxLemmaxLock,#2][#1]{lemma}{#4}[#3]{\IfValueTF{#5}{#5}{lemma}}%
}

\DeclareDocumentCommand{\TransformBoxLemmaS}{%
    s   %% star for clone
    O{} %% Changed Args
    m   %% new Name
    m   %% new Title
    o   %% new ID
}{%
    \TransformBox[usestyle=LILLYxBOXxLemma,customlist=true,listname=LEMMAS,listmen=LEMS,boxcol=\LILLYxColorxLemma,emblem={\noexpand\small\noexpand\textcolor{\noexpand\LILLYxColorxLemma}{\noexpand\faStar}},postCode={\noexpand\grenewcommand{\noexpand\LILLYxSEENxLEMMA}{TRUE}},
    lock=\LILLYxBOXxLemmaxLock,#2][#1]{lemma*}{#4}[#3]{\IfValueTF{#5}{#5}{lemmastarred}}%
}

\DeclareDocumentCommand{\TransformBoxZusammenfassung}{%
    s   %% star for clone
    O{} %% Changed Args
    m   %% new Name
    m   %% new Title
    o   %% new ID
}{%
    \TransformBox[usestyle=LILLYxBOXxZusammenfassung,customlist=true,listname=ZSMS,listmen=ZSM,boxcol=\LILLYxColorxZusammenfassung,emblem={XXNOEMBLEM},postCode={\noexpand\grenewcommand{\noexpand\LILLYxSEENxZUSAMMENFASSUNG}{TRUE}},
    lock=\LILLYxBOXxZusammenfassungxLock,#2][#1]{zusammenfassung}{#4}[#3]{\IfValueTF{#5}{#5}{zusammenfassung}}%
}

%% No Starred Zsf


%\RegisterBox[usestyle=LILLYxBOXxBemerkung,listname=Waffels,boxcol=AppleGreen]{Waffel}{Waffelbox~\noexpand\thetcbcounter~}

%\RegisterBox[usestyle=LILLYxBOXxDefinition,boxcol=\LILLYxColorxDefinition]{bemerkung}{Waffelbox~\noexpand\thetcbcounter~}


% \long\def\RegisterNewBox



% \providecommand{\LILLYxBOXxDefinitionxLock}{\LILLYxBOXxHIGHLEVELxLOCK}        \providecommand{\LILLYxBOXxDefinitionxEnable}{TRUE}         \providecommand{\LILLYxBOXxDefinitionxBox}{TRUE}
% \providecommand{\LILLYxBOXxBeispielxLock}{\LILLYxBOXxHIGHLEVELxLOCK}          \providecommand{\LILLYxBOXxBemerkungxEnable}{TRUE}          \providecommand{\LILLYxBOXxBemerkungxBox}{TRUE}
% \providecommand{\LILLYxBOXxBemerkungxLock}{\LILLYxBOXxHIGHLEVELxLOCK}         \providecommand{\LILLYxBOXxBeispielxEnable}{TRUE}           \providecommand{\LILLYxBOXxBeispielxBox}{TRUE}
% \providecommand{\LILLYxBOXxSatzxLock}{\LILLYxBOXxHIGHLEVELxLOCK}              \providecommand{\LILLYxBOXxSatzxEnable}{TRUE}
% \providecommand{\LILLYxBOXxBeweisxLock}{\LILLYxBOXxHIGHLEVELxLOCK}            \providecommand{\LILLYxBOXxBeweisxEnable}{TRUE}             \providecommand{\LILLYxBOXxBeweisxBox}{FALSE}
% \providecommand{\LILLYxBOXxLemmaxLock}{\LILLYxBOXxHIGHLEVELxLOCK}             \providecommand{\LILLYxBOXxLemmaxEnable}{TRUE}
% \providecommand{\LILLYxBOXxZusammenfassungxLock}{\LILLYxBOXxHIGHLEVELxLOCK}   \providecommand{\LILLYxBOXxZusammenfassungxEnable}{TRUE}
% \providecommand{\LILLYxBOXxAufgabexLock}{}                  \providecommand{\LILLYxBOXxAufgabexEnable}{TRUE}           \providecommand{\LILLYxBOXxAufgabexBox}{TRUE}

% \providecommand{\LILLYxBOXxUebungsblattxEnable}{TRUE}       \providecommand{\LILLYxBOXxUebungsblattxBox}{TRUE}


\newcounter{ctr_TSK} %% verwendet einen eigenen counter um im Zeifelsfall dynamisch die nummer zu ändern
\newcounter{ctr_EXE} %% Übungsblatt Counter für Mitschriebe

%%We will use the default POI-BOX if non provided
\providecommand{\LILLYxBOXxMODExDEFAULT}{DEFAULT}
\input{\LILLYxPATHxDATA/POIs/_LILLY_BOXES_DEFAULT(init)}

%% Specialboxes
\input{\LILLYxPATHxDATA/POIs/_LILLY_BOXES_SPECIAL}


%\input{\LILLYxPATHxDATA/POIs/_LILLY_BOXES_DEFAULT} % May the ones below do not cover all boxes, thus default will be happy to provide them
\ifx\LILLYxBOXxMODE\LILLYxBOXxMODExDEFAULT\else
\input{\LILLYxPATHxDATA/POIs/_LILLY_BOXES_\LILLYxBOXxMODE}
\fi


%%Liste typ counter name lock
\LILLYcommand{\LILLYxBOXESxaddListElement}[5][]{%
    \refstepcounter{#1}\phantomsection%
    \ifthenelse{\equal{#5}{\true}}{%
        \addcontentsline{#2}{#1}{\makebox[.4cm][r]{#3} #4}%
    }{% Da 1.12 mehr platz!
        \addcontentsline{#2}{#1}{\makebox[1cm][l]{#3} #4}%
    }\ignorespacesafterend%
}
%% Liste typ counter name pin lock
\LILLYcommand{\LILLYxBOXESxaddListElementxAD}[6][]{%
    \refstepcounter{#1}%
    \ifthenelse{\equal{#6}{\true}}{%
        \addcontentsline{#2}{#1}{\makebox[.4cm][r]{#3} \makebox[1em][c]{#5}~#4}%
    }{% Da 1.12 mehr platz!
        \addcontentsline{#2}{#1}{\makebox[1cm][l]{#3} \makebox[1em][c]{#5}~#4}%
    }\ignorespacesafterend%
}

\LILLYcommand{\DEFINITIONS}[1]{%
    \LILLYxBOXESxaddListElementxAD[DEFINITIONS]{DEFS}{\thetcb@cnt@LILLYxBOXxDefinition}{#1}{}{\LILLYxBOXxDefinitionxLock}%
    \refstepcounter{tcb@cnt@LILLYxBOXxDefinition}%
    %%\relax %% TODO IMPLEMENT CONVENIENT INCREMEMT => MANUAL COUNTERS?
}

\tcbset{LillyxBOXxDesignxPlain/.style={frame hidden, frame code={},leftrule=0mm, left=0pt, skin first is subskin of={emptyfirst}{frame code={},interior code={}}, skin middle is subskin of={emptymiddle}{frame code={},interior code={}},skin last is subskin of={emptylast}{frame code={},interior code={}}, colback=white,colframe=white,right=-2pt,top=0pt, fonttitle=\bfseries\color{black},attach title to upper={},enhanced,opacityfill=0}}


%% Approach do generate a general Box provider

%% {name}[initial Lock = TRUE]{ListName}{listtext}[stared-effekt]
\DeclareDocumentCommand{\DeclareLillyBox}{ m O{TRUE} m m o }{%%
    \newlistof{list@#3}{#3}{#4\\[-1.5cm]}
    %% Ist keine Box gewünscht?
    \ifx\csname LILLYxBOXx#1xBox\endcsname\false%
        \tcbset{LillyxBOXxDesignx#1/.style={LillyxBOXxDesignxPlain}}%
    \else%
        \tcbset{LillyxBOXxDesignx#1/.style={}}%
    \fi%
}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Definitionen                                                                                                        %     %%%% DEFS %%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\providecommand{\LILLYxSEENxDEFINITION}{FALSE}

\ifx\LILLYxBOXxDefinitionxEnable\true
    %\typeout{Definitions enabled}
    \newlistof{DEFINITIONS}{DEFS}{Alle Definitionen\\[-1.5cm]}
    %% TITEL OPTIONALE-ADDONS

    \ifx\LILLYxBOXxDefinitionxBox\true\tcbset{LillyxBOXxDesignxDefinition/.style={}}\else\tcbset{LillyxBOXxDesignxDefinition/.style={LillyxBOXxDesignxPlain}}\fi
    % \IfValueF{#1}{\ClassInfo{Lilly}{LILLY WARNING, Definition ohne Namen!}
    \DeclareDocumentEnvironment{definition}{O{} O{LillyxBOXxDesignxDefinition}}{\ifx\LILLYxBOXxDefinitionxBox\true\renewcommand{\LILLYxColorxLINKSxCurrentColor}{\LILLYxColorxDefinition}\fi\grenewcommand{\LILLYxSEENxDEFINITION}{TRUE}
        \begin{LILLYxBOXxDefinition}[#1][Definition \thetcbcounter~][#2]\LILLYxBOXESxaddListElementxAD[DEFINITIONS]{DEFS}{\thetcbcounter}{#1}{}{\LILLYxBOXxDefinitionxLock}\elable{auto:DEF\thetcbcounter}~\\[-.5\baselineskip]\ignorespacesafterend
    }{\end{LILLYxBOXxDefinition}\renewcommand{\LILLYxColorxLINKSxCurrentColor}{\LILLYxColorxLINKSxMainColor}\ignorespacesafterend}
    \DeclareDocumentEnvironment{definition*}{O{} O{}}{\ifx\LILLYxBOXxDefinitionxBox\true\renewcommand{\LILLYxColorxLINKSxCurrentColor}{\LILLYxColorxDefinition}\fi\grenewcommand{\LILLYxSEENxDEFINITION}{TRUE}%
    \begin{LILLYxBOXxDefinition*}[#1][Definition \thetcbcounter~][#2]\LILLYxBOXESxaddListElementxAD[DEFINITIONS]{DEFS}{\thetcbcounter}{#1}{\small\faThumbTack}{\LILLYxBOXxDefinitionxLock}\elable{auto:DEF\thetcbcounter}~\\[-.5\baselineskip]\ignorespacesafterend
    }{\end{LILLYxBOXxDefinition*}\renewcommand{\LILLYxColorxLINKSxCurrentColor}{\LILLYxColorxLINKSxMainColor}\ignorespacesafterend}
\else %% Keine Definitionen
    \typeout{Definitions disabled}
    \NewEnviron{definition}{}
    \NewEnviron{definition*}{}
\fi

%%% Comaptibility environments
\LILLYcommand{\DEF}[2]{ % Definition
    \begin{definition}[#1]
        #2
    \end{definition}
}
\LILLYcommand{\DEFS}[2]{ % Definition
    \begin{definition*}[#1]
        #2
    \end{definition*}
}


%%5 TODO Colorrename not working as expected a sclor isint found => second buffer color

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Bemerkungen                                                                                                         %     %%%% BEMS %%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\ifx\LILLYxBOXxBemerkungxEnable\true
    \newlistof{BEMERKUNGEN}{BEMS}{Alle Bemerkungen\\[-1.5cm]}

    %% TITEL OPTIONALE-ADDONS
    \ifx\LILLYxBOXxBemerkungxBox\true\tcbset{LillyxBOXxDesignxBemerkung/.style={}}\else\tcbset{LillyxBOXxDesignxBemerkung/.style={LillyxBOXxDesignxPlain}}\fi

    \DeclareDocumentEnvironment{bemerkung}{O{} O{LillyxBOXxDesignxBemerkung}}{\ifx\LILLYxBOXxBemerkungxBox\true\renewcommand{\LILLYxColorxLINKSxCurrentColor}{\LILLYxColorxBemerkung}\fi\begin{LILLYxBOXxBemerkung}[#1][Bemerkung \thetcbcounter~][#2]\LILLYxBOXESxaddListElement[BEMERKUNGEN]{BEMS}{\thetcbcounter}{#1}{\LILLYxBOXxBemerkungxLock}\elable{auto:BEM\thetcbcounter}~\\[-.5\baselineskip]\ignorespacesafterend}{\end{LILLYxBOXxBemerkung}\renewcommand{\LILLYxColorxLINKSxCurrentColor}{\LILLYxColorxLINKSxMainColor}\ignorespacesafterend}
    \DeclareDocumentEnvironment{bemerkung*}{O{} O{LillyxBOXxDesignxBemerkung}}{\begin{bemerkung}[#1][#2]\nskip}{\end{bemerkung}}

\else %% Keine Bemerkungen
    \NewEnviron{bemerkung}{}
    \NewEnviron{bemerkung*}{}
\fi

%%% Comaptibility environment
\LILLYcommand{\BEM}[2]{ % Bemerkung
    \begin{bemerkung}[#1]
        #2
    \end{bemerkung}
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Beispiele                                                                                                           %     %%%% BEIS %%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\ifx\LILLYxBOXxBeispielxEnable\true
    \newlistof{BEISPIELE}{BEIS}{Alle Beispiele\\[-1.5cm]}

    %% TITEL OPTIONALE-ADDONS
    \ifx\LILLYxBOXxBeispielxBox\true\tcbset{LillyxBOXxDesignxBeispiel/.style={}}\else\tcbset{LillyxBOXxDesignxBeispiel/.style={LillyxBOXxDesignxPlain}}\fi

    \DeclareDocumentEnvironment{beispiel}{O{} O{LillyxBOXxDesignxBeispiel}}{\ifx\LILLYxBOXxBemerkungxBox\true\renewcommand{\LILLYxColorxLINKSxCurrentColor}{\LILLYxColorxBeispiel}\fi\begin{LILLYxBOXxBeispiel}[#1][Beispiel \thetcbcounter~][#2]\LILLYxBOXESxaddListElement[BEISPIELE]{BEIS}{\thetcbcounter}{#1}{\LILLYxBOXxBeispielxLock}\elable{auto:BEI\thetcbcounter}~\\[-.5\baselineskip]\ignorespacesafterend}{\end{LILLYxBOXxBeispiel}\renewcommand{\LILLYxColorxLINKSxCurrentColor}{\LILLYxColorxLINKSxMainColor}\ignorespacesafterend}
    \DeclareDocumentEnvironment{beispiel*}{O{} O{LillyxBOXxDesignxBeispiel}}{\begin{beispiel}[#1][#2]\nskip}{\end{beispiel}}
\else %% Keine Beispielen
    \NewEnviron{beispiel}{}
    \NewEnviron{beispiel*}{}
\fi


%%% Comaptibility environment
\LILLYcommand{\BEI}[2]{ % Beispiel
    \begin{beispiel}[#1]
        #2
    \end{beispiel}
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Sätze                                                                                                               %     %%%% SATS %%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\providecommand{\LILLYxSEENxSATZ}{FALSE}

\ifx\LILLYxBOXxSatzxEnable\true
    \newlistof{SATZ}{SATZE}{Alle Sätze\\[-1.5cm]}

    %% TITEL OPTIONALE-ADDONS
    \DeclareDocumentEnvironment{satz}{O{} O{}}{\grenewcommand{\LILLYxSEENxSATZ}{TRUE}\renewcommand{\LILLYxColorxLINKSxCurrentColor}{\LILLYxColorxSatz}%
        \begin{LILLYxBOXxSatz}[#1][Satz \thetcbcounter~][#2]\LILLYxBOXESxaddListElement[SATZ]{SATZE}{\thetcbcounter}{#1}{\LILLYxBOXxSatzxLock}\elable{auto:SAT\thetcbcounter}~\\[-.5\baselineskip]\ignorespacesafterend
    }{\end{LILLYxBOXxSatz}\renewcommand{\LILLYxColorxLINKSxCurrentColor}{\LILLYxColorxLINKSxMainColor}\ignorespacesafterend}
\else %% Keine Sätze
    \NewEnviron{satz}{}
\fi

%%% Comaptibility environment
\LILLYcommand{\SAT}[2]{ % Satz
    \begin{satz}[#1]
        #2
    \end{satz}
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Beweis                                                                                                              %     %%%% BEWS %%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\ifx\LILLYxBOXxBeweisxEnable\true
    \newlistof{BEWEISE}{BEWS}{Alle Beweise\\[-1.5cm]}

    %% TITEL OPTIONALE-ADDONS
    \ifx\LILLYxBOXxBeispielxBox\true\tcbset{LillyxBOXxDesignxBeweis/.style={}}\else\tcbset{LillyxBOXxDesignxBeweis/.style={LillyxBOXxDesignxPlain}}\fi

    \DeclareDocumentEnvironment{beweis}{O{} O{LillyxBOXxDesignxBeweis}}{\ifx\LILLYxBOXxBemerkungxBox\true\renewcommand{\LILLYxColorxLINKSxCurrentColor}{\LILLYxColorxBeweis}\fi\begin{LILLYxBOXxBeweis}[#1][Beweis \thetcbcounter~][#2]\LILLYxBOXESxaddListElement[BEWEISE]{BEWS}{\thetcbcounter}{#1}{\LILLYxBOXxBeweisxLock}\elable{auto:BEW\thetcbcounter}~\\[-.5\baselineskip]\ignorespacesafterend}{\end{LILLYxBOXxBeweis}\renewcommand{\LILLYxColorxLINKSxCurrentColor}{\LILLYxColorxLINKSxMainColor}\ignorespacesafterend}
    \DeclareDocumentEnvironment{beweis*}{O{} O{LillyxBOXxDesignxBeweis}}{\begin{beweis}[#1][#2]\nskip}{\end{beweis}}
\else %% Keine Beweise
    \NewEnviron{beweis}{}
    \NewEnviron{beweis*}{}
\fi

%%% Comaptibility environment
\LILLYcommand{\BEW}[2]{ % Beweis
    \begin{beweis}[#1]
        #2
    \end{beweis}
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Lemmas                                                                                                              %     %%%% LEMS %%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\providecommand{\LILLYxSEENxLEMMA}{FALSE}


\ifx\LILLYxBOXxLemmaxEnable\true
    \newlistof{LEMMAS}{LEMME}{Alle Lemmata\\[-1.5cm]}

    %% TITEL OPTIONALE-ADDONS
    \DeclareDocumentEnvironment{lemma}{O{} O{}}{ \grenewcommand{\LILLYxSEENxLEMMA}{TRUE}\renewcommand{\LILLYxColorxLINKSxCurrentColor}{\LILLYxColorxLemma}%
        \begin{LILLYxBOXxLemma}[#1][Lemma \thetcbcounter~][#2]\LILLYxBOXESxaddListElementxAD[LEMMAS]{LEMME}{\thetcbcounter}{#1}{}{\LILLYxBOXxLemmaxLock}\elable{auto:LEM\thetcbcounter}~\\[-.5\baselineskip]\ignorespacesafterend
    }{\end{LILLYxBOXxLemma}\renewcommand{\LILLYxColorxLINKSxCurrentColor}{\LILLYxColorxLINKSxMainColor}\ignorespacesafterend}
    \DeclareDocumentEnvironment{lemma*}{O{} O{}}{ \grenewcommand{\LILLYxSEENxLEMMA}{TRUE}\renewcommand{\LILLYxColorxLINKSxCurrentColor}{\LILLYxColorxLemma}%
        \begin{LILLYxBOXxLemma}[#1~~\hbox{}\hfill\small\textcolor{\LILLYxColorxLemma}{\faStar}][Lemma \thetcbcounter~][#2]\LILLYxBOXESxaddListElementxAD[LEMMAS]{LEMME}{\thetcbcounter}{#1}{\small\faStar}{\LILLYxBOXxLemmaxLock}\elable{auto:LEM\thetcbcounter}~\\[-.5\baselineskip]\ignorespacesafterend
    }{\end{LILLYxBOXxLemma}\renewcommand{\LILLYxColorxLINKSxCurrentColor}{\LILLYxColorxLINKSxMainColor}\ignorespacesafterend}
\else %% Keine Lemmas
    \NewEnviron{lemma}{}
    \NewEnviron{lemma*}{}
\fi

%%% Comaptibility environment
\LILLYcommand{\LEM}[2]{ % Lemma
    \begin{lemma}[#1]
        #2
    \end{lemma}
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Zusammenfassungen                                                                                                   %     %%%% ZSMS %%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\providecommand{\LILLYxSEENxZUSAMMENFASSUNG}{FALSE}

\ifx\LILLYxBOXxZusammenfassungxEnable\true
    \newlistof{ZSMS}{ZSM}{Alle Zusammenfassungen\\[-1.5cm]}

    %% TITEL OPTIONALE-ADDONS
    \DeclareDocumentEnvironment{zusammenfassung}{O{} O{}}{\grenewcommand{\LILLYxSEENxZUSAMMENFASSUNG}{TRUE}\renewcommand{\LILLYxColorxLINKSxCurrentColor}{\LILLYxColorxZusammenfassung}%
        \begin{LILLYxBOXxZusammenfassung}[#1][Zusammenfassung \thetcbcounter~][#2]\LILLYxBOXESxaddListElement[ZSMS]{ZSM}{\thetcbcounter}{#1}{\LILLYxBOXxZusammenfassungxLock}\elable{auto:ZSM\thetcbcounter}~\\[-.5\baselineskip]\ignorespacesafterend
    }{\end{LILLYxBOXxZusammenfassung}\renewcommand{\LILLYxColorxLINKSxCurrentColor}{\LILLYxColorxLINKSxMainColor}\ignorespacesafterend}
\else %% Keine Zusammenfassungs
    \NewEnviron{zusammenfassung}{}
\fi

%%% Comaptibility environment
\LILLYcommand{\ZSM}[2]{ % Zusammenfassung
    \begin{zusammenfassung}[#1]
        #2
    \end{zusammenfassung}
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Aufgaben                                                                                                            %     %%%% TSKS %%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%% TODO:
%%%% BOXCONTROL \w: extra paramter [pin] - oder so lädt auf jedenfall nen tcbset style mit aftertitle = Pin .... - ist auf Definitionen gelockt - bezieht die Farbe nicht automatisch

\ifcsname LILLYxSolutionsxShow\endcsname\else%
    \def\LILLYxSolutionsxShow{TRUE}%
\fi
\ifx\LILLYxBOXxAufgabexEnable\true
    \newlistof{TSKS}{TSK}{Alle Aufgaben\\[-1.5cm]}

%% Splitter could issue a tcblower and then use startrecording to get the soluions extra?

    \ifthenelse{\equal{\LILLYxBOXxAufgabexBox}{\true}}{%
        \tcbset{LillyxBOXxDesignxAufgabe/.style={lower separated=false}}%\tcblower
        \LILLYcommand{\Splitter}{\ifx\LILLYxSolutionsxShow\true{\color{\LILLYxBOXxCOLORxFRAME}\leavevmode\\[-\baselineskip]\makebox[\linewidth]{\rule{0.725\paperwidth}{0.6pt}}}\\[0.2cm]\else\smallskip\tcblower\fi} %% Linie für tasks
        \LILLYcommand{\vSplitter}{\vspace{-1\baselineskip} \Splitter \nskip}
    }{%
        \tcbset{LillyxBOXxDesignxAufgabe/.style={LillyxBOXxDesignxPlain}}
        \LILLYcommand{\Splitter}{\vspace{0.1cm} {~\\[0.2cm]\textbf{Lösung:}\\}}
        \LILLYcommand{\vSplitter}{\vspace{-1\baselineskip} \Splitter \vspace{-1\baselineskip}}
    }


    %% [OPTIONALE-ADDONS]{TITEL}{PUNKTE}
    \DeclareDocumentEnvironment{aufgabeXdefault}{ O{} m m }{% \scantokens{ %
        \refstepcounter{ctr_TSK}%
        \ifx\LILLYxSolutionsxShow\true\else\tcbset{LillyxBOXxDesignxAufgabe/.style={        lowerbox=ignored}}\fi%
        \begin{LILLYxBOXxAufgabe}[#2][Aufgabe \arabic{ctr_TSK}][LillyxBOXxDesignxAufgabe,%
            %savedelimiter=aufgabe,savelowerto={ub/\arabic{ctr_TSK}.tex},
        #1]\LILLYxBOXESxaddListElement[TSKS]{TSK}{\arabic{ctr_TSK}}{#2}{\true}~\\[-.25\baselineskip]\ignorespacesafterend%
    }{\end{LILLYxBOXxAufgabe}}% } %
    \DeclareDocumentEnvironment{aufgabeXplain}{ O{} m m }{% \scantokens{ %
        \refstepcounter{ctr_TSK}%
        \begin{LILLYxBOXxAufgabexPlain}[#2][Aufgabe \arabic{ctr_EXE}.\arabic{ctr_TSK}][LillyxBOXxDesignxPlain,after title={\hfill~\mdseries\emph{ #3 \ifnum#3=1 Punkt\else Punkte\fi}\\[-1em]},frame hidden,#1]\LILLYxBOXESxaddListElement[TSKS]{TSK}{\arabic{ctr_TSK}}{#2}{\true}~\\\ignorespacesafterend%
    }{\end{LILLYxBOXxAufgabexPlain}}% } %
    %% Allows live Switching between styles in the same document
    \DeclareDocumentEnvironment{aufgabe}{ O{} m m }{%
        \ifx\LILLYxBOXxAufgabexBox\true\begin{aufgabeXdefault}[#1]{#2}{#3}%
        \else\begin{aufgabeXplain}[#1]{#2}{#3}\fi%
    }{%
        \ifx\LILLYxBOXxAufgabexBox\true\end{aufgabeXdefault}\else\end{aufgabeXplain}\fi%
    }

\else %% Keine Aufgaben
    \NewEnviron{aufgabe}[2][]{}
\fi

\NewEnviron{task}[3][]{\begin{aufgabe}[#1]{#2}{#3}\Body\end{aufgabe}}

\providecommand{\LILLYxSEENxUBS}{FALSE}

\ifx\LILLYxBOXxUebungsblattxEnable\true
    \newlistof{UBS}{UB}{Alle Übungsblätter\\[-1.5cm]}
    %% TITEL NUMMER
    \DeclareDocumentEnvironment{uebungsblatt}{O{} O{42}}{\grenewcommand{\LILLYxSEENxUBS}{TRUE}%

    \setcounter{ctr_EXE}{#2}\setcounter{ctr_TSK}{0}{\leavevmode\\\large \textbf{Übungsblatt} \arabic{ctr_EXE}\mdseries\hfill#1}\LILLYxBOXESxaddListElement[UBS]{UB}{\arabic{ctr_EXE}}{#1}{\true}\elable{auto:UBS\arabic{ctr_EXE}}\\[0.2\baselineskip]\ignorespacesafterend}{}
    \DeclareDocumentEnvironment{uebungsblatt*}{O{} O{42}}{\grenewcommand{\LILLYxSEENxUBS}{TRUE}% - differs: does not change counter
    {\leavevmode\\\large \textbf{Übungsblatt} #2\mdseries\hfill #1}\LILLYxBOXESxaddListElement[UBS]{UB}{#2}{#1}{\true}\elable{auto:UBS#2}\\[0.2\baselineskip]\ignorespacesafterend}{}
\else
    \NewEnviron{uebungsblatt}{}
    \NewEnviron{uebungsblatt*}{}
\fi

\providecommand{\LILLYxPolitePage}{\ifx\LILLY@Typ\LILLY@Typ@Mitschrieb\clearpage\fi}

%%% Shortcut  TITLE NUMBER
\ifx\LILLYxBOXxUebungsblattxEnable\true
    \LILLYcommand{\inputUB}[3]{\grenewcommand{\LILLYxSEENxUBS}{TRUE}\LILLYxPolitePage\begin{uebungsblatt}[#1][#2]\linput{#3}\end{uebungsblatt}\LILLYxPolitePage}
    \LILLYcommand{\inputUBS}[3]{\grenewcommand{\LILLYxSEENxUBS}{TRUE}\LILLYxPolitePage\begin{uebungsblatt*}[#1][#2]\linput{#3}\end{uebungsblatt*}\LILLYxPolitePage}
\else
    \LILLYcommand{\inputUB}[3]{\LILLYxPolitePage}
    \LILLYcommand{\inputUBS}[3]{\LILLYxPolitePage}
\fi
\endinput