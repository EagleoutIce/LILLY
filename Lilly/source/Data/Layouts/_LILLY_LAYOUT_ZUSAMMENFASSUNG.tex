\RequirePackage[automark,headsepline]{scrlayer-scrpage}         %Header konfigurieren
\RequirePackage{caption}
\RequirePackage{lastpage}                                       %Letzte Seite erhalten
\RequirePackage{titlesec}


\newif\ifappendix
\appendixfalse

\LILLYcommand{\cftsubsecleader}{\hfill}
\LILLYcommand{\cftsubsecfont}{\pgfsetfillopacity{1.0}\footnotesize}
\LILLYcommand{\cftsecfont}{\pgfsetfillopacity{1.0}\small}
\LILLYcommand{\cftchapfont}{\pgfsetfillopacity{1.0}\bfseries}

\LILLYcommand{\cftsecleader}{\normalfont{\cftdotfill{\cftsecdotsep}}}

\LILLYcommand{\cftsubsecpagefont}{\pgfsetfillopacity{0.0}}

\newcommand{\LILLYxFormatxTitle}[2][]{~\\{\bfseries\usefont{T1}{qzc}{m}{it}\fontsize{14pt}{4pt}\selectfont #2\hfill{\normalfont\tiny #1}}\\[-0.3cm]
\noindent\rule{\textwidth}{1.25pt}\\[0.15cm]}

\newlistof{TOPS}{TOP}{\LILLYxFormatxTitle{Inhaltsverzeichnis}\vspace*{-2cm}}

\LILLYcommand{\LILLYxLayoutxClear}{ %
    \pagestyle{empty} %KOMA-FTW!
    \pagenumbering{gobble}
}
\LILLYcommand{\LILLYxLayoutxRestore}{ %
\pagenumbering{arabic}
\pagestyle{scrheadings} %KOMA-FTW!
\ifx\LILLYxMODE\LILLYxMODExPRINT
    \lehead{\textsf{$\mathbf{\arabic{TOPICS}}\mid\,$ \normalfont\textsf{\leftmark}}}
    \rohead{\normalfont\textsf{\VORLESUNG}}
    \cofoot{{\scriptsize{\AUTHOR}}}
    \cefoot{{\scriptsize{\TITLE}}}
    \ofoot{\normalfont\textbf{\thepage}}
    \chead{}
\else
    \lohead{\AUTHOR}
    \lofoot{\silentHmark[\small\textit{Thema}]{eagleTOC}[\LILLYxColorxLINKSxMainColor]\textnormal{\guilsinglright}\leftmark}
    \cfoot{}
    \chead{}
    \rohead{\VORLESUNG}
    \ifx\LILLYxFOOTERxBUTTONS\true %
        \rofoot{\raisebox{0.75pt}{\eXButton{Find}{\tiny \faSearch} \text{ } \eXButton{GoBack}{\tiny \faUndo} \text{ } \eXButton{GoForward}{\tiny \faRepeat}\text{ } \eXButton{PrevPage}{\(\LHD\)}} \thepage/\pageref{LastPage} \raisebox{0.75pt}{\eXButton{NextPage}{\(\RHD\)}}} %
    \else %
        \rofoot{\thepage/\pageref{LastPage}} %
    \fi %
\fi
}

\providecommand{\LILLYxBOXxDefinitionxLock}{TRUE}

\setlength{\parindent}{0pt}
\newcounter{ctr_ADDONS}

\newcommand{\startAppendix}{\clearpage\par\phantomsection%
\addcontentsline{toc}{section}{Anhang}\addcontentsline{TOPIC}{TOPICS}{Anhang}\addcontentsline{DEFS}{chapter}{Anhang}\appendixtrue%
\ifx\LILLYxMODE\LILLYxMODExPRINT\lehead{\textsf{$\mathbf{A}\mid\,$ \normalfont\textsf{Anhang}}}%
\else\lofoot{\silentHmark[\small\textit{Thema}]{eagleTOC}[\LILLYxColorxLINKSxMainColor]\textnormal{\guilsinglright}Anhang}%
\fi
}

\newcommand{\theTOPIC}{undefined}
\newcommand{\listTOPICSname}{\leavevmode\\[-4.75cm]}
\newlistof{TOPICS}{TOPIC}{\listTOPICSname}
\newcommand{\TOPICS}[1]{%
\renewcommand{\theTOPIC}{#1}%
\refstepcounter{TOPICS}%
\ifnum\value{TOPICS}>0\addcontentsline{TOPIC}{TOPICS}{#1}\fi\par%
}

\def\compileidx{\makeindex[title=Stichwortverzeichnis,options=-s \LILLYxPATHxINDEX,columns=2,columnsep=0.75cm]\renewcommand{\indexname}{Stichwortverzeichnis}}

\newcommand{\aLink}[1]{%
    \ifx\LILLYxMODE\LILLYxMODExPRINT%
        \pageref{#1}%
    \else%
        \jmark[\faLeanpub]{#1}%
    \fi%
}


\providecommand{\TOP}[3][top_default_jmpmrk]{%
    \ifappendix%
    \refstepcounter{ctr_ADDONS}\addcontentsline{toc}{subsection}{#2}\else%
    \ifnum\value{TOPICS}>-1\addcontentsline{DEFS}{chapter}{#2}\fi\addcontentsline{toc}{section}{#2}%
    \TOPICS{#2}\markleft{#2}\fi\elable{top:#1}%
    \leavevmode\\%%breakpatch
    \parbox{\linewidth}{{\bfseries\usefont{T1}{qzc}{m}{it}\fontsize{14pt}{4pt}\selectfont \ifappendix\arabic{ctr_ADDONS}\else\arabic{TOPICS}\fi) #2} \hfill{\tiny #3}}\vspace{-0.5\baselineskip}\newline%
    \rule{\textwidth}{2pt}\smallskip\\\ignorespaces%
}

\DeclareRobustCommand{\kw}[1]{\textbf{#1}\index{#1}}
\DeclareRobustCommand{\sw}[2][Gruppenname]{#2\index{#1!#2}}
\DeclareRobustCommand{\sr}[3][Gruppenname]{#3\index{#1!#2!#3}}

\compileidx

\AtBeginDocument{
    \LILLYxLayoutxRestore
}


%% TODO: make small arrow in limerence if page breaks